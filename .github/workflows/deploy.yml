name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: orbnetregistry.azurecr.io
  CONTAINER_APP_NAME: orbguard-lab
  RESOURCE_GROUP: ORB
  CONTAINER_APP_ENV: orbnet-prod-env
  IMAGE_NAME: orbguard-lab
  NEO4J_ACI_NAME: neo4j-orbguard-aci
  NEO4J_DNS_LABEL: neo4j-orbguard

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Ensure Neo4j Container Instance exists
        run: |
          # Check if Neo4j ACI exists
          NEO4J_EXISTS=$(az container show --name ${{ env.NEO4J_ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "name" -o tsv 2>/dev/null || echo "")

          if [ -z "$NEO4J_EXISTS" ]; then
            echo "Creating Neo4j Azure Container Instance..."
            az container create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.NEO4J_ACI_NAME }} \
              --image neo4j:5-community \
              --os-type Linux \
              --cpu 2 \
              --memory 4 \
              --ports 7687 7474 \
              --dns-name-label ${{ env.NEO4J_DNS_LABEL }} \
              --ip-address Public \
              --environment-variables \
                NEO4J_AUTH=${{ secrets.NEO4J_AUTH }} \
                NEO4J_server_memory_heap_initial__size=1G \
                NEO4J_server_memory_heap_max__size=2G \
                NEO4J_dbms_connector_bolt_listen__address=0.0.0.0:7687 \
                NEO4J_dbms_connector_bolt_advertised__address=${{ env.NEO4J_DNS_LABEL }}.uaenorth.azurecontainer.io:7687 \
              --restart-policy OnFailure
            echo "Neo4j ACI created successfully"

            # Wait for Neo4j to start
            echo "Waiting for Neo4j to start..."
            sleep 60
          else
            echo "Neo4j ACI already exists"
            # Check if running, restart if stopped
            STATE=$(az container show --name ${{ env.NEO4J_ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "instanceView.state" -o tsv)
            if [ "$STATE" != "Running" ]; then
              echo "Neo4j is not running, starting..."
              az container start --name ${{ env.NEO4J_ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
              sleep 30
            fi
          fi

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                       -t ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          containerAppEnvironment: ${{ env.CONTAINER_APP_ENV }}
          imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          targetPort: 8090
          ingress: external
